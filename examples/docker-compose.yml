version: '3.8'

services:
  # ============ KAFKA ============
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    healthcheck:
      test: [ "CMD", "nc", "-z", "localhost", "2181" ]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: [ "CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list" ]
      interval: 10s
      timeout: 10s
      retries: 10

  # Create Kafka topics
  kafka-init:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: [ "/bin/sh", "-c" ]
    command: |
      "
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic logs.application --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic metrics.application --partitions 3 --replication-factor 1
      kafka-topics --bootstrap-server kafka:29092 --create --if-not-exists --topic traces.application --partitions 3 --replication-factor 1
      echo 'Topics created!'
      "

  # ============ VECTOR (Kafka consumer for logs -> Loki) ============
  vector:
    image: timberio/vector:0.34.1-alpine
    container_name: vector
    depends_on:
      kafka:
        condition: service_healthy
      loki:
        condition: service_healthy
    ports:
      - "8686:8686" # Vector API
    volumes:
      - ./vector/vector.yaml:/etc/vector/vector.yaml:ro
      - vector-data:/var/lib/vector
    environment:
      VECTOR_LOG: info
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8686/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ VECTOR AGENT (docker logs -> Kafka) ============
  vector-agent:
    image: timberio/vector:0.34.1-alpine
    container_name: vector-agent
    depends_on:
      kafka:
        condition: service_healthy
    volumes:
      - ./vector/vector-agent.yaml:/etc/vector/vector.yaml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - vector-agent-data:/var/lib/vector
    environment:
      VECTOR_LOG: info

  # ============ OTEL COLLECTOR GATEWAY (Kafka consumer for traces/metrics) ============
  otel-gateway:
    image: otel/opentelemetry-collector-contrib:0.91.0
    container_name: otel-gateway
    depends_on:
      kafka:
        condition: service_healthy
      tempo:
        condition: service_started
      mimir:
        condition: service_started
    ports:
      - "8888:8888"   # Collector internal telemetry
      - "9090:9090"   # Metrics pipeline output (optional Prometheus scrape)
      - "13133:13133" # Health check
    volumes:
      - ./otel-collector/config.yaml:/etc/otelcol-contrib/config.yaml:ro
    command: [ "--config=/etc/otelcol-contrib/config.yaml" ]

  # ============ OTEL COLLECTOR AGENT (OTLP -> Kafka) ============
  otel-agent:
    image: otel/opentelemetry-collector-contrib:0.91.0
    container_name: otel-agent
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "4317:4317" # OTLP gRPC for SDKs
      - "4318:4318" # OTLP HTTP (optional)
      - "13134:13133" # Separate health check port on host
    volumes:
      - ./otel-collector/agent-config.yaml:/etc/otelcol-contrib/config.yaml:ro
    command: [ "--config=/etc/otelcol-contrib/config.yaml" ]

  # ============ KAFKA UI ============
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092

  # ============ LOKI ============
  loki:
    image: grafana/loki:3.0.0
    container_name: loki
    command: -config.file=/etc/loki/loki-config.yaml
    volumes:
      - ./loki/loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - loki-data:/loki
    ports:
      - "3100:3100"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ============ TEMPO ============
  tempo:
    image: grafana/tempo:2.3.0
    container_name: tempo
    command: -config.file=/etc/tempo/tempo-config.yaml
    volumes:
      - ./tempo/tempo-config.yaml:/etc/tempo/tempo-config.yaml:ro
      - tempo-data:/var/tempo
    ports:
      - "3200:3200"   # Tempo query endpoint
      - "4417:4317"   # OTLP gRPC (from gateway/agents)
      - "4418:4318"   # OTLP HTTP (optional)

  # ============ MIMIR ============
  mimir:
    image: grafana/mimir:2.12.0
    container_name: mimir
    command: ["-config.file=/etc/mimir/mimir-config.yaml", "-target=all"]
    volumes:
      - ./mimir/mimir-config.yaml:/etc/mimir/mimir-config.yaml:ro
      - mimir-data:/var/mimir
    ports:
      - "9009:9009"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9009/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ============ GRAFANA ============
  grafana:
    image: grafana/grafana:10.4.0
    container_name: grafana
    depends_on:
      loki:
        condition: service_healthy
      tempo:
        condition: service_started
      mimir:
        condition: service_healthy
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_UNIFIED_ALERTING_ENABLED: "true"
      GF_SMTP_ENABLED: "true"
      GF_SMTP_HOST: "smtp.office365.com:587"
      GF_SMTP_USER: "do-not-reply@centricity.co.in"
      GF_SMTP_PASSWORD: "Z&846171327537ur"
      GF_SMTP_FROM_ADDRESS: "do-not-reply@centricity.co.in"
      GF_SMTP_FROM_NAME: "Grafana Alerts"
    volumes:
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/provisioning/alerting:/etc/grafana/provisioning/alerting:ro
      - grafana-data:/var/lib/grafana

volumes:
  vector-data:
  vector-agent-data:
  loki-data:
  tempo-data:
  mimir-data:
  grafana-data:

